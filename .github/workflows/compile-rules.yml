# .github/workflows/compile-rules.yml

name: Compile Sing-box Ruleset

on:
  push:
    branches:
      - main
    paths:
      - 'source/**.json'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and setup sing-box
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${LATEST_TAG#v}-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz
          echo "$(pwd)/sing-box-${LATEST_TAG#v}-linux-amd64" >> $GITHUB_PATH

      - name: Create output directory
        run: mkdir -p dist

      - name: Compile all JSON rulesets to SRS
        run: |
          for file in source/*.json; do
            filename=$(basename "$file" .json)
            echo "Compiling $file to dist/$filename.srs"
            # <<< 这里是修改后的关键命令，移除了 --input
            sing-box rule-set compile "$file" --output "dist/$filename.srs"
          done

      - name: Commit compiled files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-compile rulesets"
          file_pattern: "dist/*.srs"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
